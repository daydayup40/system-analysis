# 虚拟设备权限管理的设计实现
内容：

- 项目简介
- 功能需求
- 项目进展
- 设计实现

## 项目简介
openthos系统上，通过使用虚拟设备加数据转发的方式对上层应用进行权限控制。让上层软件统统跟硬件隔离，所有程序只能看到虚拟设备；上层要做的修改就是让壳知道调用者的身份，壳决定返回真数据还是假数据。我们改动HAL硬件抽象层，实现我们要的过滤和转发；

### 当前开发人员
苗德行
张善民
黄志伟
萧络元

## 功能需求
对上层应用申请的各种设备访问等权限，通过虚拟设备加数据转发的方式进行权限管理。<br>
要求虚拟权限管理能实现在HAL层区分是哪个app发出的请求，并根据APP-权限管理配置，选择合适的虚拟驱动或真实驱动。

## 项目进展
序号|名称 | 备注|时间阶段|说明
------------- | ------------- | ------------- |-------------| -------------
1| Camera权限管理| doing|201907|初步完成，并继续改进，苗德行
2| Audio权限管理| doing|201907|开发研究中，苗德行
3| GPS权限管理| doing|201907|开发研究中，张善民

## 设计实现

### 应用权限管理方案

讨论结果认为的可行的解决方案是由FrameWork层判断某一应用是否被授予了某一运行时权限。<br>
以Camera为例，如果应用申请了Camera权限且被授予运行时权限，此时可以正常访问物理摄像头；如果应用申请了Camera权限但没有被授予运行时权限，此时应用程序不会退出，但是获得的数据来自虚拟摄像头。<br>
因此，需要修改的代码涉及到FrameWork（运行时权限判断）和HAL（虚拟设备）两部分。<br>
- 刘总建议：使用虚拟设备加数据转发的方式。让上层软件统统跟硬件隔离，所有程序只能看到虚拟设备；上层要做的修改就是让壳知道调用者的身份，壳决定返回真数据还是假数据。我们改动HAL硬件抽象层，实现我们要的过滤和转发；<br>
通过重点修改HAL来实现，希望在android之外自己维护一个“真实权限”表，android自己的权限会被流氓app检测胡搞，android内部维护的权限统统自动许可，我们的权限表才是真实生效的<br>

##### Camera
系统启动时init.sh挂载的虚拟摄像头驱动vivid；在HAL层中可以通过传参来决定open()物理摄像头还是vivid虚拟摄像头,。
关于与权限管理的关联，认为可行的方案是在FrameWork层中判断出某一应用是否被授予了权限，CameraService中是可以拿到PackageName、PID、UID，而HAL层看不到，通过系统属性property的设置，在HAL层中作出判断并进行摄像头切换，这个在5.1中实现过可行。<br>
APP每次到HAL的调用都要知道调用者身份，是否有权限是查表的事情，不关framework，包名传递下来给HAL，HAL自己维护一张内存权限表，这张表也可以由特权app来维护，一张内存里面的小规模表格。（权限表部分刘总表示再想想）

- 讨论建议：不建议使用property方式，但具体实现方式目前不确定

##### Audio
按照黄sir的建议可以加载虚拟驱动snd-dummy，但是因为系统支持的音频接口可以有多个，且音频接口中又包含了若干个outputs & inputs，并且每个output & input又包含了若干个devices，这就意味着按照camera方式在HAL层中通过设备节点切换会有大量的修改；而且如果通过虚拟驱动的方式依然绕不过一个大的问题，因为audio并不是某一应用独占，如果切换到虚拟audio，将会影响到所有应用无法使用audio.
所以，讨论结论是在framework层对要过滤的应用程序进行数据流过滤的方式，而不修改底层HAL.

- 讨论建议：audio i/o采用mixer方式，根据权限是否授予，过滤掉相应应用的音频数据

##### GPS
没有现成的虚拟驱动，单纯回传数据的方案考虑不够周全。
应用在使用定位服务时，会优先使用GPS，如果没有则使用WIFI定位的方式，对此与陈老师讨论建议使用一个虚拟GPS设备用于不授权应用，而不需再考虑WIFI定位的情况。<br>
刘总要求的通过主要修改GPS HAL的方式来实现，不走捷径。

- 讨论建议：做一个软件gps设备，它定期从真实gps中取到信息，然后根据调用者权限返回真假数据

##### Bluetooth
虚拟蓝牙设备，提供随机化的mac和空的附近蓝牙设备列表<br>

針對劉總提到虛擬的藍牙設備，調研了 kernel 的 hci_vhci driver
搭配 BlueZ 的 btvirt tool，可以成功的建立虛擬的 hci 介面。
不過藍牙應用開啟此介面時，仍會出錯導致 com.andrond.bluetooth 崩潰。
看起來 BT stack 可能仍需調整才能適用此介面。

比較簡單的方式，是在 HAL 直接處理，
針對沒有權限的應用，給予空的回應。
例如將 Send 指令直接丟棄，而 Receive 就是 timeout。
這個不需利用虛擬設備就可以辦到。

##### 网络、蓝牙等设备
考虑在framework层对过滤的应用使用timeout的方式

#### 如何将某一时刻某一设备是由哪个应用使用的信息传递到HAL的问题，陈老师建议对Camera、GPS等构建统一通道，把包名等信息从上层传递到底层。
